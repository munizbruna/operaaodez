import React, { useState, useEffect, useRef } from 'react';
import { Play, Pause, RotateCcw, CheckCircle, ArrowLeft, Dumbbell, Timer, Flame, Volume2, VolumeX, Calendar, Zap } from 'lucide-react';

// --- DATA: O Plano de Treino ---
const WORKOUT_PLAN = {
  A: {
    title: "Treino A: Inferior (Foco Quadríceps)",
    description: "Alta intensidade, pouco descanso.",
    exercises: [
      {
        id: 'a1',
        type: 'biset',
        title: 'Bi-Set: Pressão e Panturrilha',
        items: [
          { name: 'Leg Press 45º', details: '4x 12 reps (Carga Alta ~80kg+)' },
          { name: 'Panturrilha no Leg', details: '4x 15 reps (Sem descanso após Leg)' }
        ],
        restTime: 45
      },
      {
        id: 'a2',
        type: 'single',
        title: 'Agachamento (Livre/Smith)',
        items: [
          { name: 'Agachamento', details: '3x 12 reps (Descida lenta: 3s)' }
        ],
        restTime: 60
      },
      {
        id: 'a3',
        type: 'single',
        title: 'Cadeira Extensora',
        items: [
          { name: 'Cadeira Extensora', details: '3x 15 reps (Última série: Drop-set até a falha)' }
        ],
        restTime: 45
      },
      {
        id: 'a4',
        type: 'single',
        title: 'Cadeira Adutora',
        items: [
          { name: 'Cadeira Adutora', details: '3x 20 reps (Espremer no meio)' }
        ],
        restTime: 45
      }
    ]
  },
  B: {
    title: "Treino B: Superior + Core",
    description: "Manutenção de massa e postura.",
    exercises: [
      {
        id: 'b1',
        type: 'biset',
        title: 'Bi-Set: Dorsal e Peito',
        items: [
          { name: 'Puxada Frontal', details: '3x 12 reps' },
          { name: 'Flexão de Braços', details: '3x Máximo possível' }
        ],
        restTime: 50
      },
      {
        id: 'b2',
        type: 'biset',
        title: 'Bi-Set: Remada e Tríceps',
        items: [
          { name: 'Remada Baixa', details: '3x 12 a 15 reps' },
          { name: 'Tríceps Pulley (Corda)', details: '3x 12 a 15 reps' }
        ],
        restTime: 50
      },
      {
        id: 'b3',
        type: 'biset',
        title: 'Bi-Set: Ombros',
        items: [
          { name: 'Desenvolvimento Halteres', details: '3x 10 reps' },
          { name: 'Elevação Lateral', details: '3x 12 reps' }
        ],
        restTime: 45
      },
      {
        id: 'b4',
        type: 'biset',
        title: 'Bi-Set: Abdômen',
        items: [
          { name: 'Prancha Abdominal', details: '3x 40 segundos (Use o Timer!)' },
          { name: 'Abdominal Supra', details: '3x 20 reps' }
        ],
        restTime: 45
      }
    ]
  },
  C: {
    title: "Treino C: Posterior e Glúteo",
    description: "Foco na cadeia posterior.",
    exercises: [
      {
        id: 'c1',
        type: 'biset',
        title: 'Bi-Set: Pré-Exaustão',
        items: [
          { name: 'Mesa Flexora', details: '4x 12 reps' },
          { name: 'Cadeira Abdutora', details: '4x 20 reps (Tronco inclinado)' }
        ],
        restTime: 45
      },
      {
        id: 'c2',
        type: 'single',
        title: 'Stiff',
        items: [
          { name: 'Stiff (Barra/Halteres)', details: '3x 12 reps (Foco no alongamento)' }
        ],
        restTime: 60
      },
      {
        id: 'c3',
        type: 'single',
        title: 'Elevação Pélvica',
        items: [
          { name: 'Elevação Pélvica', details: '3x 10 reps (Segura 2s em cima)' }
        ],
        restTime: 60
      },
      {
        id: 'c4',
        type: 'single',
        title: 'Cadeira Flexora',
        items: [
          { name: 'Cadeira Flexora', details: '3x 15 reps' }
        ],
        restTime: 45
      }
    ]
  }
};

const RUNNING_PROTOCOL = [
  { week: 'Semana 1', dates: '23/11 - 30/11', action: '2 min Corre / 1 min Anda (Total 15 min)' },
  { week: 'Semana 2', dates: '01/12 - 07/12', action: '3 min Corre / 1 min Anda (Total 20 min)' },
  { week: 'Semana 3', dates: '08/12 - 14/12', action: '5 min Corre / 2 min Anda (Total 25 min)' },
  { week: 'Semana 4', dates: '15/12 - 21/12', action: '10 a 15 min Contínuos (Teste)' },
];

// --- SOUND UTILS ---
const playBeep = (type = 'end') => {
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  if (!AudioContext) return;

  const ctx = new AudioContext();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  osc.connect(gain);
  gain.connect(ctx.destination);

  if (type === 'end') {
    osc.type = 'sine';
    osc.frequency.setValueAtTime(880, ctx.currentTime); // A5
    osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.1);
    gain.gain.setValueAtTime(0.5, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
    osc.start();
    osc.stop(ctx.currentTime + 0.5);
  } else {
    // Tick sound
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(600, ctx.currentTime);
    gain.gain.setValueAtTime(0.1, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
    osc.start();
    osc.stop(ctx.currentTime + 0.1);
  }
};

// --- COMPONENTS ---

const Header = ({ title, subtitle, onBack }) => (
  <div className="bg-slate-900 text-white p-4 sticky top-0 z-10 shadow-lg">
    <div className="flex items-center gap-3">
      {onBack && (
        <button onClick={onBack} className="p-2 hover:bg-slate-800 rounded-full transition-colors">
          <ArrowLeft size={24} />
        </button>
      )}
      <div>
        <h1 className="text-xl font-bold text-emerald-400 uppercase tracking-wider">{title}</h1>
        {subtitle && <p className="text-xs text-slate-400">{subtitle}</p>}
      </div>
    </div>
  </div>
);

const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden ${className}`}>
    {children}
  </div>
);

const TimerModal = ({ exercise, onClose, defaultRestTime }) => {
  const [mode, setMode] = useState('workout'); // 'workout' (stopwatch) or 'rest' (countdown)
  const [time, setTime] = useState(0);
  const [isActive, setIsActive] = useState(false);
  const [restDuration, setRestDuration] = useState(defaultRestTime);
  const [isMuted, setIsMuted] = useState(false);
  
  const timerRef = useRef(null);

  // Efeito de Narração (Text-to-Speech)
  useEffect(() => {
    if (!exercise || !('speechSynthesis' in window) || isMuted) return;

    // Constrói o texto de narração limpando abreviações para soar mais natural
    const speechText = exercise.items.map(item => {
      let details = item.details
        .replace(/(\d+)x/gi, '$1 séries de')
        .replace(/reps/gi, 'repetições')
        .replace(/\//g, ' ou ')
        .replace(/~/g, 'aproximadamente ')
        .replace(/\+/g, 'mais ');
        
      return `${item.name}. ${details}`;
    }).join('. E na sequência: ');

    const fullText = `Iniciando ${exercise.title}. ${speechText}`;

    const utterance = new SpeechSynthesisUtterance(fullText);
    utterance.lang = 'pt-BR';
    utterance.rate = 1.0; // Velocidade normal
    
    // Cancela falas anteriores para não sobrepor
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);

    // Cleanup: para de falar se fechar o modal
    return () => {
      window.speechSynthesis.cancel();
    };
  }, [exercise, isMuted]); // Executa ao abrir o exercício

  useEffect(() => {
    if (isActive) {
      timerRef.current = setInterval(() => {
        setTime(prev => {
          if (mode === 'rest') {
            if (prev <= 1) {
              playBeep('end');
              setIsActive(false);
              return 0;
            }
            return prev - 1;
          } else {
            return prev + 1;
          }
        });
      }, 1000);
    } else {
      clearInterval(timerRef.current);
    }
    return () => clearInterval(timerRef.current);
  }, [isActive, mode]);

  const toggleTimer = () => setIsActive(!isActive);
  
  const resetTimer = () => {
    setIsActive(false);
    setTime(mode === 'rest' ? restDuration : 0);
  };

  const startRest = () => {
    setMode('rest');
    setTime(restDuration);
    setIsActive(true);
  };

  const backToWorkout = () => {
    setMode('workout');
    setTime(0);
    setIsActive(false); // User starts manually
  };

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
  };

  return (
    <div className="fixed inset-0 bg-black/90 z-50 flex flex-col items-center justify-center p-4">
      <Card className="w-full max-w-md bg-slate-900 border-slate-700 text-white relative">
        {/* Botão de Mute no topo */}
        <button 
          onClick={() => setIsMuted(!isMuted)}
          className="absolute top-4 right-4 p-2 text-slate-400 hover:text-white rounded-full bg-slate-800"
        >
          {isMuted ? <VolumeX size={18} /> : <Volume2 size={18} />}
        </button>

        <div className="p-6 text-center">
          <h3 className="text-lg font-bold text-emerald-400 mb-2">{exercise.title}</h3>
          <div className="space-y-2 mb-6 text-sm text-slate-300">
            {exercise.items.map((item, idx) => (
              <div key={idx} className="flex justify-between border-b border-slate-700 pb-1">
                <span>{item.name}</span>
                <span className="text-emerald-200 font-mono">{item.details.split('(')[0]}</span>
              </div>
            ))}
          </div>

          <div className={`text-6xl font-mono font-bold mb-8 tabular-nums ${mode === 'rest' ? 'text-amber-400' : 'text-white'}`}>
            {formatTime(time)}
          </div>

          <div className="grid grid-cols-2 gap-4">
            {/* Control Buttons */}
            <button 
              onClick={toggleTimer}
              className={`flex items-center justify-center gap-2 p-4 rounded-lg font-bold text-lg transition-all ${
                isActive ? 'bg-red-500 hover:bg-red-600' : 'bg-emerald-500 hover:bg-emerald-600'
              }`}
            >
              {isActive ? <><Pause /> Pausar</> : <><Play /> {mode === 'rest' ? 'Descansar' : 'Iniciar'}</>}
            </button>

            <button 
              onClick={resetTimer}
              className="flex items-center justify-center gap-2 p-4 bg-slate-700 hover:bg-slate-600 rounded-lg font-bold text-lg"
            >
              <RotateCcw /> Resetar
            </button>
          </div>

          {/* Mode Switcher */}
          <div className="mt-6 flex gap-2 justify-center">
            {mode === 'workout' ? (
              <button 
                onClick={startRest} 
                className="w-full py-3 bg-amber-600 hover:bg-amber-700 rounded-lg font-bold text-white flex items-center justify-center gap-2"
              >
                <Timer size={20} /> Ir para Descanso ({restDuration}s)
              </button>
            ) : (
              <button 
                onClick={backToWorkout} 
                className="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-lg font-bold text-white flex items-center justify-center gap-2"
              >
                <Dumbbell size={20} /> Voltar para Execução
              </button>
            )}
          </div>

          <button onClick={onClose} className="mt-8 text-slate-400 hover:text-white underline text-sm">
            Fechar / Voltar para Lista
          </button>
        </div>
      </Card>
    </div>
  );
};

export default function App() {
  const [view, setView] = useState('home'); // 'home', 'A', 'B', 'C'
  const [activeExercise, setActiveExercise] = useState(null);

  // --- Lógica de Sugestão de Dia ---
  const getDailySuggestion = () => {
    const day = new Date().getDay(); // 0 = Dom, 1 = Seg, ...
    const weekDays = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
    
    // Mapeamento baseado no seu plano:
    // Seg(1): A, Ter(2): B, Qua(3): C, Qui(4): B, Sex(5): A, Sab(6): Cardio, Dom(0): Off
    const schedule = {
      1: { type: 'workout', key: 'A', title: 'Treino A' },
      2: { type: 'workout', key: 'B', title: 'Treino B' },
      3: { type: 'workout', key: 'C', title: 'Treino C' },
      4: { type: 'workout', key: 'B', title: 'Treino B' },
      5: { type: 'workout', key: 'A', title: 'Treino A (ou C)' },
      6: { type: 'cardio', title: 'Cardio ao Ar Livre' },
      0: { type: 'rest', title: 'Descanso Total' }
    };

    return {
      dayName: weekDays[day],
      ...schedule[day]
    };
  };

  const suggestion = getDailySuggestion();
  const currentWorkout = WORKOUT_PLAN[view];

  if (view === 'home') {
    return (
      <div className="min-h-screen bg-slate-100 font-sans text-slate-800 pb-10">
        <Header title="Operação Dezembro" subtitle="Meta: 70kg | Corrida 5km" />
        
        <div className="p-4 space-y-6">
          
          {/* --- BLOCO DE DESTAQUE DO DIA --- */}
          <div className="bg-gradient-to-r from-slate-900 to-slate-800 p-6 rounded-2xl text-white shadow-xl border-l-4 border-emerald-500 relative overflow-hidden">
            <div className="relative z-10">
              <div className="flex items-center gap-2 text-emerald-400 mb-1 font-bold uppercase tracking-wider text-xs">
                <Calendar size={14} />
                <span>Hoje é {suggestion.dayName}</span>
              </div>
              
              <h2 className="text-2xl font-bold mb-2 text-white">
                {suggestion.type === 'rest' ? 'Recuperação Muscular' : 
                 suggestion.type === 'cardio' ? 'Dia de Cardio' : 
                 'Hora do Treino!'}
              </h2>

              <p className="text-slate-300 text-sm mb-4">
                {suggestion.type === 'workout' && `Hoje é dia de focar no ${suggestion.title}. Prepare sua água.`}
                {suggestion.type === 'cardio' && "Hoje o foco é gastar energia. Trote ou caminhada acelerada ao ar livre."}
                {suggestion.type === 'rest' && "O descanso também é treino. Alimente-se bem e hidrate-se."}
              </p>

              {suggestion.type === 'workout' && (
                <button 
                  onClick={() => setView(suggestion.key)}
                  className="w-full bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition-all shadow-lg shadow-emerald-500/20"
                >
                  <Zap size={20} fill="currentColor" />
                  Iniciar {suggestion.title} Agora
                </button>
              )}
              
              {suggestion.type === 'cardio' && (
                <div className="bg-white/10 p-3 rounded-lg text-sm text-emerald-200">
                  <span className="font-bold">Meta:</span> 40-50 min de atividade moderada.
                </div>
              )}
            </div>
            
            {/* Background Icon Decoration */}
            <Timer className="absolute -right-6 -bottom-6 text-white/5 w-40 h-40" />
          </div>
          {/* ---------------------------------- */}

          <div className="space-y-4">
            <h2 className="font-bold text-xl text-slate-800 flex items-center gap-2">
              <Dumbbell size={20} /> Todos os Treinos
            </h2>
            {Object.keys(WORKOUT_PLAN).map(key => (
              <button
                key={key}
                onClick={() => setView(key)}
                className="w-full bg-white p-5 rounded-xl shadow-sm border border-slate-200 hover:border-emerald-400 transition-all text-left group"
              >
                <div className="flex justify-between items-center mb-1">
                  <span className="font-bold text-2xl text-emerald-500">{key}</span>
                  <div className="bg-slate-100 p-2 rounded-full group-hover:bg-emerald-50 transition-colors">
                    <ArrowLeft className="rotate-180 text-slate-400 group-hover:text-emerald-500" size={20} />
                  </div>
                </div>
                <h3 className="font-bold text-lg text-slate-800">{WORKOUT_PLAN[key].title}</h3>
                <p className="text-sm text-slate-500">{WORKOUT_PLAN[key].description}</p>
              </button>
            ))}
          </div>

          <div className="space-y-4">
            <h2 className="font-bold text-xl text-slate-800 mt-6 flex items-center gap-2">
              <Flame size={20} /> Protocolo de Corrida
            </h2>
            <Card className="divide-y divide-slate-100">
              {RUNNING_PROTOCOL.map((item, index) => (
                <div key={index} className="p-4 text-sm">
                  <div className="flex justify-between font-bold text-slate-700 mb-1">
                    <span>{item.week}</span>
                    <span className="text-xs font-normal text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">{item.dates}</span>
                  </div>
                  <p className="text-slate-600">{item.action}</p>
                </div>
              ))}
            </Card>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 pb-20">
      <Header 
        title={currentWorkout.title.split(':')[0]} 
        subtitle={currentWorkout.title.split(':')[1]} 
        onBack={() => setView('home')} 
      />

      <div className="p-4 space-y-4">
        {currentWorkout.exercises.map((exercise, index) => (
          <Card key={exercise.id} className="relative group">
            <div className="absolute top-0 left-0 w-1 h-full bg-emerald-500" />
            
            <div className="p-5">
              <div className="flex justify-between items-start mb-3">
                <span className={`text-xs font-bold px-2 py-1 rounded uppercase tracking-wide ${exercise.type === 'biset' ? 'bg-amber-100 text-amber-700' : 'bg-blue-100 text-blue-700'}`}>
                  {exercise.type === 'biset' ? 'Bi-Set (Sem descanso entre eles)' : 'Série Normal'}
                </span>
                <span className="flex items-center text-xs text-slate-500 gap-1 bg-slate-100 px-2 py-1 rounded-full">
                  <Timer size={12} /> Descanso: {exercise.restTime}s
                </span>
              </div>

              <div className="space-y-3 mb-4">
                {exercise.items.map((item, i) => (
                  <div key={i} className="flex flex-col">
                    <span className="font-bold text-slate-800 text-lg">{item.name}</span>
                    <span className="text-sm text-slate-500">{item.details}</span>
                  </div>
                ))}
              </div>

              <button
                onClick={() => setActiveExercise(exercise)}
                className="w-full bg-slate-900 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:bg-emerald-600 transition-colors shadow-lg shadow-emerald-900/10"
              >
                <Play size={18} /> Iniciar Exercício
              </button>
            </div>
          </Card>
        ))}

        <div className="mt-8 p-4 bg-emerald-50 rounded-xl border border-emerald-200">
          <h3 className="font-bold text-emerald-800 mb-2 flex items-center gap-2">
            <CheckCircle size={20} /> Pós-Treino: Corrida
          </h3>
          <p className="text-sm text-emerald-700 mb-2">
            Verifique o protocolo da semana na página inicial. Lembre-se: Velocidade de trote 8.5 a 9.5km/h.
          </p>
        </div>
      </div>

      {activeExercise && (
        <TimerModal 
          exercise={activeExercise} 
          defaultRestTime={activeExercise.restTime}
          onClose={() => setActiveExercise(null)} 
        />
      )}
    </div>
  );
}
