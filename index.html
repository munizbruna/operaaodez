<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desafio Barriga Zero - Bruna</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.9); }
        
        .input-compact { 
            background: #f8fafc; border: 1px solid #e2e8f0; 
            border-radius: 6px; padding: 4px 8px; font-size: 0.875rem; 
            width: 100%; transition: all 0.2s;
        }
        .input-compact:focus { border-color: #ec4899; outline: none; box-shadow: 0 0 0 2px rgba(236, 72, 153, 0.1); }
        
        .card-done { border-color: #ec4899; background-color: #fdf2f8; }
        .card-done .input-compact { background: white; border-color: #fbcfe8; }
        
        .action-btn {
            display: flex; align-items: center; justify-content: center;
            padding: 8px; border-radius: 8px; font-weight: 600; font-size: 0.85rem;
            transition: all 0.2s; gap: 4px;
        }
        .btn-exec { background: #f1f5f9; color: #334155; }
        .btn-exec:active { background: #cbd5e1; }
        
        .btn-rest { background: #fff7ed; color: #c2410c; }
        .btn-rest:active { background: #ffedd5; }
        
        .btn-check { background: #fdf2f8; color: #be185d; border: 1px solid #fbcfe8; }
        .btn-check.checked { background: #db2777; color: white; border-color: #be185d; }

        .badge-bi { background-color: #fce7f3; color: #be185d; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; }
        
        /* Spinner de Carregamento */
        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid #ec4899;
            border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Container de Vídeo Responsivo (16:9) */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border-radius: 0.75rem;
            background-color: #000;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800 pb-24 select-none">

    <div id="app"></div>

    <!-- Modal do Timer -->
    <div id="timer-modal" class="fixed inset-0 modal-overlay z-50 hidden flex flex-col items-center justify-center p-4 fade-in">
        <div class="w-full max-w-md bg-slate-900 border border-slate-700 text-white rounded-xl shadow-2xl relative overflow-hidden">
            <button id="btn-mute" class="absolute top-4 right-4 p-2 text-slate-400 hover:text-white rounded-full bg-slate-800 transition-colors">
                <i data-lucide="volume-2" id="icon-volume"></i>
            </button>
            <div class="p-6 text-center">
                <div class="mb-4">
                    <span id="modal-mode-badge" class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide bg-pink-500 text-white">Execução</span>
                </div>
                <h3 id="modal-title" class="text-lg font-bold text-white mb-2"></h3>
                <div id="timer-display" class="text-7xl font-mono font-bold mb-8 tabular-nums text-white tracking-tighter">0:00</div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button id="btn-toggle-timer" class="flex items-center justify-center gap-2 p-4 rounded-xl font-bold text-lg transition-all bg-pink-500 hover:bg-pink-600 text-white shadow-lg shadow-pink-900/20">
                        <i data-lucide="play"></i> <span id="lbl-toggle">Iniciar</span>
                    </button>
                    <button id="btn-reset-timer" class="flex items-center justify-center gap-2 p-4 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl font-bold text-lg">
                        <i data-lucide="rotate-ccw"></i> Resetar
                    </button>
                </div>
                <button id="btn-close-modal" class="text-slate-400 hover:text-white text-sm w-full py-2">Minimizar / Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Vídeo/Guia -->
    <div id="guide-modal" class="fixed inset-0 modal-overlay z-[60] hidden flex flex-col items-center justify-center p-4 fade-in">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl relative overflow-hidden border border-slate-200 flex flex-col max-h-[90vh]">
            
            <div class="p-4 border-b border-slate-100 flex justify-between items-start bg-white z-10">
                <div>
                    <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded mb-1 inline-block bg-pink-100 text-pink-700">Instrução</span>
                    <h3 id="guide-exercise-title" class="text-xl font-bold text-slate-800 leading-tight"></h3>
                </div>
                <button onclick="closeGuide()" class="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors">
                    <i data-lucide="x" class="text-slate-500" width="20"></i>
                </button>
            </div>
            
            <div class="overflow-y-auto p-4 flex-1">
                <!-- Área do Vídeo (Iframe) -->
                <div id="video-wrapper" class="hidden mb-6 shadow-lg">
                    <div class="video-container">
                        <div id="youtube-player-slot"></div>
                    </div>
                </div>
                
                <!-- Mensagem sem vídeo -->
                <div id="no-video-msg" class="hidden mb-6 text-center p-6 bg-slate-100 rounded-xl border border-slate-200">
                    <i data-lucide="video-off" class="mx-auto text-slate-400 mb-2" width="24"></i>
                    <p class="text-sm text-slate-500">Vídeo indisponível no momento.</p>
                </div>

                <div class="bg-blue-50 p-4 rounded-xl mb-4 border border-blue-100">
                    <h4 class="font-bold text-blue-800 text-sm mb-2 flex items-center gap-2">
                        <i data-lucide="info" width="16"></i> Dica Técnica:
                    </h4>
                    <div id="guide-text" class="text-sm text-blue-900 leading-relaxed space-y-2"></div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-100 bg-white">
                <button onclick="closeGuide()" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-slate-900/10 active:scale-95 transition-transform">
                    Entendi, bora treinar!
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- DADOS DO TREINO (ADAPTADO PARA BRUNA) ---
        const WORKOUT_PLAN = {
            HIIT: {
                title: "Treino HIIT (Vídeo)",
                description: "Acompanhe o vídeo e use o timer.",
                // URL DO VÍDEO SOLICITADO
                videoUrl: "https://player.scaleup.com.br/embed/e0229955ffae46810c47ae0c30708d3e5755accf",
                exercises: [
                    { 
                        id: 'h_01', type: 'biset', title: 'Bloco 1: Aquecimento', 
                        items: [
                            { 
                                name: 'Polichinelos (Exemplo)', 
                                details: '30 a 45 seg',
                                guide: 'Salte abrindo pernas e braços simultaneamente. Mantenha o abdômen contraído.',
                                video: '#'
                            },
                            { 
                                name: 'Corrida Estacionária', 
                                details: '30 a 45 seg',
                                guide: 'Corra no lugar elevando bem os joelhos.',
                                video: '#'
                            }
                        ], restTime: 15 
                    },
                    { 
                        id: 'h_02', type: 'biset', title: 'Bloco 2: Alta Intensidade', 
                        items: [
                            { 
                                name: 'Agachamento com Salto', 
                                details: '30 seg (Máxima Intensidade)',
                                guide: 'Agache e suba explodindo em um salto. Amorteça a queda.',
                                video: '#'
                            },
                            { 
                                name: 'Mountain Climbers', 
                                details: '30 seg (Máxima Intensidade)',
                                guide: 'Em posição de prancha, traga os joelhos ao peito alternadamente em velocidade.',
                                video: '#'
                            }
                        ], restTime: 30 
                    },
                    { 
                        id: 'h_03', type: 'biset', title: 'Bloco 3: Core', 
                        items: [
                            { 
                                name: 'Prancha Toca Ombro', 
                                details: '40 seg',
                                guide: 'Em posição de prancha, toque a mão direita no ombro esquerdo e vice-versa, sem girar o quadril.',
                                video: '#'
                            },
                            { 
                                name: 'Burpee (Opcional)', 
                                details: '10 reps ou 30 seg',
                                guide: 'Mãos no chão, jogue os pés atrás, volte e salte. Se for muito difícil, faça sem o salto (Sprawl).',
                                video: '#'
                            }
                        ], restTime: 45 
                    }
                ]
            },
            A: {
                title: "Treino A: Full Body 1",
                description: "Foco: Quadríceps + Costas/Peito/Ombro",
                exercises: [
                    { 
                        id: 'a_aq', type: 'single', title: 'Aquecimento', 
                        items: [
                            { 
                                name: 'Mobilidade + Agachamento Peso Corporal', 
                                details: '1x 15 reps',
                                guide: 'Faça movimentos controlados para lubrificar as articulações.',
                                video: 'https://www.youtube.com/watch?v=86ZW7tmmLuU'
                            }
                        ], restTime: 0 
                    },
                    { 
                        id: 'a_b1', type: 'biset', title: 'Bi-set 01', 
                        items: [
                            { 
                                name: 'Agachamento Livre', 
                                details: '3x 10 a 12 reps',
                                guide: 'Mantenha a coluna reta e desça até a coxa ficar paralela ao chão.',
                                video: 'https://www.youtube.com/watch?v=86ZW7tmmLuU'
                            },
                            { 
                                name: 'Puxada Alta Frente (ou Remada Curvada)', 
                                details: '3x 10 a 12 reps',
                                guide: 'Puxe a barra em direção ao peito, fechando as escápulas.',
                                video: 'https://www.youtube.com/watch?v=Xn-fIQw08q4'
                            }
                        ], restTime: 60 
                    },
                    { 
                        id: 'a_b2', type: 'biset', title: 'Bi-set 02', 
                        items: [
                            { 
                                name: 'Leg Press 45', 
                                details: '3x 10 a 12 reps',
                                guide: 'Não estenda totalmente os joelhos no final do movimento.',
                                video: 'https://www.youtube.com/watch?v=HG2vEDoCgcA'
                            },
                            { 
                                name: 'Elevação Lateral', 
                                details: '3x 10 a 12 reps',
                                guide: 'Leve os halteres até o aparelho de Leg Press para otimizar o tempo.',
                                video: 'https://www.youtube.com/shorts/nhQ4mdk0TmM'
                            }
                        ], restTime: 60 
                    },
                    { 
                        id: 'a_b3', type: 'biset', title: 'Bi-set 03', 
                        items: [
                            { 
                                name: 'Cadeira Extensora', 
                                details: '3x 10 a 12 reps',
                                guide: 'Segure 1 segundo no topo da contração (perna esticada).',
                                video: 'https://www.youtube.com/watch?v=pJZXbaF-MCM'
                            },
                            { 
                                name: 'Voador (Peitoral)', 
                                details: '3x 10 a 12 reps',
                                guide: 'Mantenha os cotovelos levemente flexionados e peito estufado.',
                                video: 'https://www.youtube.com/watch?v=a5XwjsD3AOI'
                            }
                        ], restTime: 60 
                    },
                    { 
                        id: 'a_b4', type: 'biset', title: 'Bi-set 04', 
                        items: [
                            { 
                                name: 'Gêmeos em Pé', 
                                details: '3x 10 a 12 reps',
                                guide: 'Amplitude máxima: suba tudo e desça tudo.',
                                video: 'https://www.youtube.com/watch?v=5BeosiUEQgA'
                            },
                            { 
                                name: 'Tríceps Pulley (Barra W)', 
                                details: '3x 10 a 12 reps',
                                guide: 'Cotovelos colados no corpo, mova apenas o antebraço.',
                                video: 'https://www.youtube.com/watch?v=CJrOh5oPoRY'
                            }
                        ], restTime: 60 
                    },
                    { 
                        id: 'a_fim', type: 'biset', title: 'Finalizador', 
                        items: [
                            { 
                                name: 'Rosca Martelo', 
                                details: '3x 10 a 12 reps',
                                guide: 'Pegada neutra (palmas voltadas para dentro).',
                                video: 'https://www.youtube.com/watch?v=E0l0yA_tY6U'
                            },
                            { 
                                name: 'Abdominal Reto', 
                                details: '3x 10 a 12 reps',
                                guide: 'Concentre a força no abdômen, solte o ar ao subir.',
                                video: 'https://www.youtube.com/watch?v=9eeeUjV4r_I'
                            }
                        ], restTime: 45 
                    }
                ]
            },
            B: {
                title: "Treino B: Full Body 2",
                description: "Foco: Posterior/Glúteo + Costas/Peito/Ombro",
                exercises: [
                    { 
                        id: 'b_aq', type: 'single', title: 'Aquecimento', 
                        items: [
                            { 
                                name: 'Mobilidade Inferiores', 
                                details: '1x 15 reps',
                                guide: 'Aquecimento geral para pernas.',
                                video: '#'
                            }
                        ], restTime: 0 
                    },
                    { 
                        id: 'b_b1', type: 'biset', title: 'Bi-set 01', 
                        items: [
                            { 
                                name: 'Cadeira Flexora', 
                                details: '3x 10 a 12 reps',
                                guide: 'Ajuste bem o encosto para não compensar com a lombar.',
                                video: 'https://www.youtube.com/watch?v=YextIqwQQ4w'
                            },
                            { 
                                name: 'Remada Baixa Pronada', 
                                details: '3x 10 a 12 reps',
                                guide: 'Tronco firme, puxe levando os cotovelos para trás.',
                                video: 'https://www.youtube.com/watch?v=PjjTICd7xlo'
                            }
                        ], restTime: 60 
                    },
                    { 
                        id: 'b_b2', type: 'biset', title: 'Bi-set 02', 
                        items: [
                            { 
                                name: 'Mesa Flexora', 
                                details: '3x 10 a 12 reps',
                                guide: 'Não deixe o quadril levantar do banco ao subir o peso.',
                                video: 'https://www.youtube.com/watch?v=mbrziwTrHIY'
                            },
                            { 
                                name: 'Supino Inclinado (Halteres)', 
                                details: '3x 10 a 12 reps',
                                guide: 'Banco a 30-45 graus. Desça alongando bem o peitoral.',
                                video: 'https://www.youtube.com/watch?v=WP1VLAt8hbM'
                            }
                        ], restTime: 60 
                    },
                    { 
                        id: 'b_b3', type: 'biset', title: 'Bi-set 03', 
                        items: [
                            { 
                                name: 'Leg Press (Pés Altos)', 
                                details: '3x 10 a 12 reps',
                                guide: 'Pés mais altos na plataforma para focar em posterior e glúteo.',
                                video: 'https://www.youtube.com/watch?v=HG2vEDoCgcA'
                            },
                            { 
                                name: 'Crucifixo Inverso Máquina', 
                                details: '3x 10 a 12 reps',
                                guide: 'Foco na parte de trás do ombro.',
                                video: 'https://www.youtube.com/watch?v=iVwOmlHa_MI'
                            }
                        ], restTime: 60 
                    },
                    { 
                        id: 'b_b4', type: 'biset', title: 'Bi-set 04', 
                        items: [
                            { 
                                name: 'Cadeira Abdutora', 
                                details: '3x 10 a 12 reps',
                                guide: 'Tronco levemente inclinado à frente para maior ativação do glúteo.',
                                video: 'https://www.youtube.com/watch?v=50qHGus1TZk'
                            },
                            { 
                                name: 'Tríceps Corda', 
                                details: '3x 10 a 12 reps',
                                guide: 'Abra a corda no final do movimento para contração máxima.',
                                video: 'https://www.youtube.com/watch?v=_c-eSh3PbSo'
                            }
                        ], restTime: 60 
                    },
                    { 
                        id: 'b_fim', type: 'biset', title: 'Finalizador', 
                        items: [
                            { 
                                name: 'Rosca Direta (Cabo)', 
                                details: '3x 10 a 12 reps',
                                guide: 'Mantenha postura ereta e cotovelos fixos.',
                                video: 'https://www.youtube.com/watch?v=D2mghpkuF4M'
                            },
                            { 
                                name: 'Prancha Abdominal', 
                                details: '3x Até a falha',
                                guide: 'Abdômen contraído, corpo em linha reta.',
                                video: 'https://www.youtube.com/watch?v=j6VeEp9A_DA'
                            }
                        ], restTime: 45 
                    }
                ]
            }
        };

        // --- SISTEMA DE DADOS (LOCALSTORAGE) ---
        const DATA_KEY = 'desafio_bruna_bi_set_v1';
        let currentWorkoutKey = null;

        function getTodayKey() { return new Date().toLocaleDateString('pt-BR'); }
        function getAllData() { return JSON.parse(localStorage.getItem(DATA_KEY) || '{}'); }
        function getTodayData() {
            const all = getAllData(); const today = getTodayKey();
            if (!all[today]) all[today] = {}; return all[today];
        }
        function saveExerciseData(exerciseId, data) {
            const all = getAllData(); const today = getTodayKey();
            if (!all[today]) all[today] = {};
            all[today][exerciseId] = { ...all[today][exerciseId], ...data };
            localStorage.setItem(DATA_KEY, JSON.stringify(all));
        }
        function getExerciseData(exerciseId) { return getTodayData()[exerciseId] || {}; }

        // --- GLOBAL STATE ---
        let timerInterval = null;
        let timerTime = 0;
        let timerMode = 'workout'; 
        let timerActive = false;
        let currentRestTime = 0;

        const appDiv = document.getElementById('app');
        const modal = document.getElementById('timer-modal');
        const guideModal = document.getElementById('guide-modal');
        const timerDisplay = document.getElementById('timer-display');
        const badgeMode = document.getElementById('modal-mode-badge');

        // --- VIDEO & GUIDE LOGIC ---
        function extractVideoId(url) {
            // Suporta formatos: youtube.com/watch?v=ID, youtu.be/ID, youtube.com/shorts/ID
            const regExp = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=|shorts\/)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = url.match(regExp);
            return (match && match[1]) ? match[1] : null;
        }

        function openGuide(exerciseIndex, itemIndex) {
            if (!currentWorkoutKey) return;
            
            const exercise = WORKOUT_PLAN[currentWorkoutKey].exercises[exerciseIndex].items[itemIndex];

            // Set Text
            document.getElementById('guide-exercise-title').innerText = exercise.name;
            document.getElementById('guide-text').innerText = exercise.guide || "Siga as orientações do seu treinador.";
            
            // Handle Video
            const videoWrapper = document.getElementById('video-wrapper');
            const noVideoMsg = document.getElementById('no-video-msg');
            const playerSlot = document.getElementById('youtube-player-slot');
            
            // Limpa anterior
            playerSlot.innerHTML = '';

            if (exercise.video && exercise.video !== '#') {
                const videoId = extractVideoId(exercise.video);
                
                if (videoId) {
                    videoWrapper.classList.remove('hidden');
                    noVideoMsg.classList.add('hidden');
                    
                    // Injeta Iframe
                    playerSlot.innerHTML = `
                        <iframe 
                            src="https://www.youtube.com/embed/${videoId}?rel=0&autoplay=0&modestbranding=1&playsinline=1" 
                            title="YouTube video player" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen>
                        </iframe>
                    `;
                } else {
                    // Tem link mas não conseguiu extrair ID
                    videoWrapper.classList.add('hidden');
                    noVideoMsg.classList.remove('hidden');
                }
            } else {
                // Sem vídeo cadastrado
                videoWrapper.classList.add('hidden');
                noVideoMsg.classList.remove('hidden');
            }

            guideModal.classList.remove('hidden');
            lucide.createIcons();
        }

        function closeGuide() { 
            guideModal.classList.add('hidden'); 
            // Remove o iframe para parar o vídeo imediatamente
            document.getElementById('youtube-player-slot').innerHTML = '';
        }

        // --- RENDER HOME ---
        function renderHome() {
            currentWorkoutKey = null;
            const today = new Date().getDay(); // 0 = Dom, 1 = Seg...
            
            // Sugestão baseada na rotina de 5 dias
            const schedule = {
                1: { key: 'A', title: 'Treino A (Seg)' },
                2: { key: 'B', title: 'Treino B (Ter)' },
                3: { key: 'HIIT', title: 'HIIT / Cardio (Qua)' },
                4: { key: 'A', title: 'Treino A (Qui)' },
                5: { key: 'B', title: 'Treino B (Sex)' },
                6: { key: 'HIIT', title: 'HIIT / Cardio (Sáb)' },
                0: { key: 'HIIT', title: 'HIIT / Cardio (Dom)' }
            };

            const suggestion = schedule[today] || schedule[0];
            const workoutsKeys = Object.keys(WORKOUT_PLAN);
            
            let html = `
                <div class="bg-slate-900 text-white p-5 sticky top-0 z-10 shadow-lg mb-4">
                    <div class="flex justify-between items-end">
                        <div>
                            <p class="text-xs text-pink-400 font-bold uppercase tracking-widest mb-1">Desafio Barriga Zero</p>
                            <h1 class="text-xl font-bold">Olá, Bruna!</h1>
                        </div>
                        <div class="text-right">
                             <p class="text-xs text-slate-400">Hoje</p>
                             <p class="text-lg font-bold text-white">${suggestion.title}</p>
                        </div>
                    </div>
                </div>

                <div class="p-4 space-y-6 fade-in pb-20">
            `;

            if (suggestion.key) {
                 html += `
                    <button onclick="renderWorkout('${suggestion.key}')" class="w-full bg-pink-600 hover:bg-pink-700 text-white p-6 rounded-2xl shadow-xl shadow-pink-900/20 text-left transition-transform active:scale-95 border border-pink-500 relative overflow-hidden group">
                        <div class="relative z-10">
                            <span class="bg-pink-800 text-pink-100 text-xs px-2 py-1 rounded font-bold uppercase">Sugestão do Dia</span>
                            <h2 class="text-3xl font-bold mt-2 mb-1">Treino ${suggestion.key}</h2>
                            <p class="text-pink-100 text-sm opacity-90">${WORKOUT_PLAN[suggestion.key].description}</p>
                        </div>
                        <i data-lucide="zap" class="absolute right-[-20px] bottom-[-20px] w-32 h-32 text-pink-400 opacity-20 group-hover:scale-110 transition-transform"></i>
                    </button>
                 `;
            }

            html += `<h3 class="font-bold text-slate-700 text-lg flex items-center gap-2 mt-6"><i data-lucide="list"></i> Seus Treinos</h3>
                     <div class="grid gap-3">`;

            workoutsKeys.forEach(key => {
                const plan = WORKOUT_PLAN[key];
                html += `
                    <button onclick="renderWorkout('${key}')" class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex justify-between items-center hover:border-pink-500 transition-colors text-left">
                        <div>
                            <h4 class="font-bold text-slate-800">${plan.title}</h4>
                            <p class="text-xs text-slate-500">${plan.description}</p>
                        </div>
                        <div class="bg-slate-100 p-2 rounded-full text-slate-400">
                            <i data-lucide="chevron-right" width="20"></i>
                        </div>
                    </button>
                `;
            });

            html += `</div></div>`;
            appDiv.innerHTML = html;
            lucide.createIcons();
        }

        // --- RENDER WORKOUT ---
        function renderWorkout(key) {
            currentWorkoutKey = key;
            const plan = WORKOUT_PLAN[key];
            
            let html = `
                <div class="bg-white border-b border-slate-200 sticky top-0 z-20 px-4 py-3 flex items-center gap-3 shadow-sm">
                    <button onclick="renderHome()" class="p-2 -ml-2 hover:bg-slate-100 rounded-full text-slate-600">
                        <i data-lucide="arrow-left"></i>
                    </button>
                    <div>
                        <h1 class="font-bold text-lg leading-tight text-slate-800">${plan.title}</h1>
                        <p class="text-xs text-slate-500">${plan.videoUrl ? 'Assista ao vídeo abaixo' : 'Toque no nome para ver o vídeo'}</p>
                    </div>
                </div>

                <div class="p-4 space-y-4 pb-32 max-w-lg mx-auto">
            `;

            // SE TIVER VÍDEO DO TREINO (HIIT)
            if (plan.videoUrl) {
                html += `
                    <div class="video-container shadow-lg rounded-xl mb-6">
                        <iframe 
                            src="${plan.videoUrl}" 
                            title="Treino Video" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen>
                        </iframe>
                    </div>
                    <div class="bg-blue-50 border border-blue-100 p-4 rounded-xl text-sm text-blue-900 mb-6">
                        <p class="font-bold mb-1 flex items-center gap-2"><i data-lucide="info" width="16"></i> Instruções:</p>
                        Abaixo está uma sugestão de exercícios para acompanhar este vídeo. Use o timer de cada bloco para marcar seu tempo.
                    </div>
                `;
            }

            plan.exercises.forEach((ex, exIdx) => {
                const stored = getExerciseData(ex.id);
                const isDone = stored.done;
                
                let itemsHtml = '';
                ex.items.forEach((item, itemIdx) => {
                    const savedWeight = stored.items?.[itemIdx]?.weight || '';
                    const savedReps = stored.items?.[itemIdx]?.reps || '';
                    
                    const nameButton = `
                        <button onclick="openGuide(${exIdx}, ${itemIdx})" class="font-bold text-slate-700 text-sm flex items-center gap-2 hover:text-pink-600 text-left transition-colors w-full mb-1">
                            ${item.name} <i data-lucide="play-circle" width="14" class="text-red-500"></i>
                        </button>
                    `;

                    // Se for HIIT, não mostra peso, apenas Reps/Tempo se necessário
                    const inputsHtml = (key === 'HIIT') ? `
                         <p class="text-xs text-slate-500 bg-slate-50 p-2 rounded border border-slate-100 mt-1">${item.details}</p>
                    ` : `
                        <div class="flex gap-2">
                            <div class="relative w-1/2">
                                <input type="number" placeholder="kg" value="${savedWeight}" id="w-${ex.id}-${itemIdx}" class="input-compact pl-7" inputmode="numeric">
                                <span class="absolute left-2 top-1.5 text-xs text-slate-400 font-bold">Kg</span>
                            </div>
                            <div class="relative w-1/2">
                                <input type="number" placeholder="Reps" value="${savedReps}" id="r-${ex.id}-${itemIdx}" class="input-compact pl-2 text-center" inputmode="numeric">
                            </div>
                        </div>
                    `;

                    itemsHtml += `
                        <div class="mb-4 last:mb-0 relative pl-3 border-l-2 border-slate-100">
                            ${nameButton}
                            ${key !== 'HIIT' ? `<p class="text-[10px] text-slate-400 font-mono mb-2">${item.details}</p>` : ''}
                            ${inputsHtml}
                        </div>
                    `;
                });

                html += `
                    <div id="card-${ex.id}" class="bg-white rounded-xl border-2 ${isDone ? 'card-done' : 'border-slate-200'} shadow-sm transition-all duration-300">
                        <div class="p-4 pb-2 border-b border-slate-100/50 flex justify-between items-center">
                            <span class="badge-bi">
                                ${ex.title}
                            </span>
                            <span class="text-xs text-slate-400 flex items-center gap-1">
                                <i data-lucide="clock" width="12"></i> ${ex.restTime}s
                            </span>
                        </div>
                        <div class="p-4">${itemsHtml}</div>
                        <div class="p-2 border-t border-slate-100 grid grid-cols-3 gap-2">
                            <button onclick="openTimer('workout', '${ex.title}', 0)" class="action-btn btn-exec">
                                <i data-lucide="play" width="16"></i> Timer
                            </button>
                            <button onclick="openTimer('rest', 'Descanso', ${ex.restTime})" class="action-btn btn-rest">
                                <i data-lucide="timer" width="16"></i> Descanso
                            </button>
                            <button onclick="toggleDone('${ex.id}', ${ex.items.length})" id="btn-check-${ex.id}" class="action-btn btn-check ${isDone ? 'checked' : ''}">
                                <i data-lucide="${isDone ? 'check' : 'square'}" width="16"></i> ${isDone ? 'Feito' : 'Concluir'}
                            </button>
                        </div>
                    </div>
                `;
            });

            html += `</div>`;
            appDiv.innerHTML = html;
            lucide.createIcons();
            window.scrollTo(0, 0);
        }

        // --- FUNÇÕES DE AÇÃO ---
        function toggleDone(exId, itemsCount) {
            const card = document.getElementById(`card-${exId}`);
            const btn = document.getElementById(`btn-check-${exId}`);
            const itemsData = [];
            // Para HIIT não precisamos salvar inputs necessariamente, mas mantemos a estrutura
            const isHiit = currentWorkoutKey === 'HIIT';
            
            if (!isHiit) {
                for(let i=0; i<itemsCount; i++) {
                    const w = document.getElementById(`w-${exId}-${i}`).value;
                    const r = document.getElementById(`r-${exId}-${i}`).value;
                    itemsData.push({ weight: w, reps: r });
                }
            }
            
            const currentData = getExerciseData(exId);
            const newState = !currentData.done;
            saveExerciseData(exId, { done: newState, items: itemsData });

            if (newState) {
                card.classList.add('card-done');
                card.classList.remove('border-slate-200');
                btn.classList.add('checked');
                btn.innerHTML = `<i data-lucide="check" width="16"></i> Feito`;
                confetti({ particleCount: 30, spread: 50, origin: { y: 0.7 }, colors: ['#ec4899', '#be185d'] });
            } else {
                card.classList.remove('card-done');
                card.classList.add('border-slate-200');
                btn.classList.remove('checked');
                btn.innerHTML = `<i data-lucide="square" width="16"></i> Concluir`;
            }
            lucide.createIcons();
        }

        function saveHiit() {
            // Deprecated logic kept for compatibility
            const time = document.getElementById('hiit-time').value;
            if(!time) return;
            localStorage.setItem(DATA_KEY + '_hiit_' + getTodayKey(), time);
        }

        // --- TIMER LOGIC ---
        function openTimer(mode, title, duration) {
            timerMode = mode;
            currentRestTime = duration;
            document.getElementById('modal-title').innerText = title;
            if (mode === 'workout') {
                timerTime = 0;
                badgeMode.innerText = "Execução";
                badgeMode.className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide bg-blue-500 text-white";
                document.getElementById('lbl-toggle').innerText = "Iniciar Cronômetro";
                timerDisplay.classList.remove('text-amber-400');
                timerDisplay.classList.add('text-white');
            } else {
                timerTime = duration;
                badgeMode.innerText = "Descanso";
                badgeMode.className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide bg-amber-500 text-white";
                document.getElementById('lbl-toggle').innerText = "Iniciar Contagem";
                timerDisplay.classList.add('text-amber-400');
                timerDisplay.classList.remove('text-white');
            }
            updateDisplay();
            stopTimer();
            modal.classList.remove('hidden');
        }

        function updateDisplay() {
            const mins = Math.floor(timerTime / 60);
            const secs = timerTime % 60;
            timerDisplay.innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function toggleTimer() { if (timerActive) stopTimer(); else startTimer(); }
        
        function startTimer() {
            timerActive = true;
            document.getElementById('lbl-toggle').innerText = "Pausar";
            const btn = document.getElementById('btn-toggle-timer');
            btn.classList.remove('bg-pink-500', 'hover:bg-pink-600');
            btn.classList.add('bg-red-500', 'hover:bg-red-600');
            timerInterval = setInterval(() => {
                if (timerMode === 'rest') {
                    if (timerTime <= 0) { playBeep(); stopTimer(); return; }
                    timerTime--;
                } else { timerTime++; }
                updateDisplay();
            }, 1000);
        }

        function stopTimer() {
            timerActive = false;
            clearInterval(timerInterval);
            document.getElementById('lbl-toggle').innerText = timerMode === 'rest' ? "Continuar" : "Iniciar";
            const btn = document.getElementById('btn-toggle-timer');
            btn.classList.add('bg-pink-500', 'hover:bg-pink-600');
            btn.classList.remove('bg-red-500', 'hover:bg-red-600');
        }

        function resetTimer() { stopTimer(); timerTime = timerMode === 'rest' ? currentRestTime : 0; updateDisplay(); }

        function playBeep() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, ctx.currentTime);
            gain.gain.setValueAtTime(0.5, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
            osc.start();
            osc.stop(ctx.currentTime + 0.5);
        }

        document.getElementById('btn-close-modal').onclick = () => { modal.classList.add('hidden'); stopTimer(); };
        document.getElementById('btn-toggle-timer').onclick = toggleTimer;
        document.getElementById('btn-reset-timer').onclick = resetTimer;

        renderHome();
    </script>
</body>
</html>


