<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operação Dezembro - Tracker Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.9); }
        
        /* Inputs compactos para mobile */
        .input-compact { 
            background: #f8fafc; border: 1px solid #e2e8f0; 
            border-radius: 6px; padding: 4px 8px; font-size: 0.875rem; 
            width: 100%; transition: all 0.2s;
        }
        .input-compact:focus { border-color: #10b981; outline: none; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1); }
        
        .card-done { border-color: #10b981; background-color: #ecfdf5; }
        .card-done .input-compact { background: white; border-color: #bef264; }
        
        /* Botões de Ação no Card */
        .action-btn {
            display: flex; align-items: center; justify-content: center;
            padding: 8px; border-radius: 8px; font-weight: 600; font-size: 0.85rem;
            transition: all 0.2s; gap: 4px;
        }
        .btn-exec { background: #f1f5f9; color: #334155; }
        .btn-exec:active { background: #cbd5e1; }
        
        .btn-rest { background: #fff7ed; color: #c2410c; }
        .btn-rest:active { background: #ffedd5; }
        
        .btn-check { background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }
        .btn-check.checked { background: #10b981; color: white; border-color: #059669; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800 pb-24 select-none">

    <div id="app"></div>

    <!-- Modal do Timer -->
    <div id="timer-modal" class="fixed inset-0 modal-overlay z-50 hidden flex flex-col items-center justify-center p-4 fade-in">
        <div class="w-full max-w-md bg-slate-900 border border-slate-700 text-white rounded-xl shadow-2xl relative overflow-hidden">
            <button id="btn-mute" class="absolute top-4 right-4 p-2 text-slate-400 hover:text-white rounded-full bg-slate-800 transition-colors">
                <i data-lucide="volume-2" id="icon-volume"></i>
            </button>
            <div class="p-6 text-center">
                <div class="mb-4">
                    <span id="modal-mode-badge" class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide bg-emerald-500 text-white">Execução</span>
                </div>
                <h3 id="modal-title" class="text-lg font-bold text-white mb-2"></h3>
                <div id="timer-display" class="text-7xl font-mono font-bold mb-8 tabular-nums text-white tracking-tighter">0:00</div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button id="btn-toggle-timer" class="flex items-center justify-center gap-2 p-4 rounded-xl font-bold text-lg transition-all bg-emerald-500 hover:bg-emerald-600 text-white shadow-lg shadow-emerald-900/20">
                        <i data-lucide="play"></i> <span id="lbl-toggle">Iniciar</span>
                    </button>
                    <button id="btn-reset-timer" class="flex items-center justify-center gap-2 p-4 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl font-bold text-lg">
                        <i data-lucide="rotate-ccw"></i> Resetar
                    </button>
                </div>

                <button id="btn-close-modal" class="text-slate-400 hover:text-white text-sm w-full py-2">Minimizar / Fechar</button>
            </div>
        </div>
    </div>

    <script>
        // --- DADOS DO TREINO (Mantidos) ---
        const WORKOUT_PLAN = {
            A: {
                title: "Treino A: Inferior (Quadríceps)",
                description: "Alta intensidade, pouco descanso.",
                exercises: [
                    { id: 'a1', type: 'biset', title: 'Bi-Set: Pressão e Panturrilha', items: [{ name: 'Leg Press 45º', details: '4x 12 reps (~80kg+)' }, { name: 'Panturrilha no Leg', details: '4x 15 reps (Sem descanso)' }], restTime: 45 },
                    { id: 'a2', type: 'single', title: 'Agachamento', items: [{ name: 'Agachamento', details: '3x 12 reps (Descida lenta: 3s)' }], restTime: 60 },
                    { id: 'a3', type: 'single', title: 'Cadeira Extensora', items: [{ name: 'Cadeira Extensora', details: '3x 15 reps (Drop-set na última)' }], restTime: 45 },
                    { id: 'a4', type: 'single', title: 'Cadeira Adutora', items: [{ name: 'Cadeira Adutora', details: '3x 20 reps (Espremer no meio)' }], restTime: 45 }
                ]
            },
            B: {
                title: "Treino B: Superior + Core",
                description: "Manutenção de massa e postura.",
                exercises: [
                    { id: 'b1', type: 'biset', title: 'Bi-Set: Dorsal e Peito', items: [{ name: 'Puxada Frontal', details: '3x 12 reps' }, { name: 'Flexão de Braços', details: '3x Máximo' }], restTime: 50 },
                    { id: 'b2', type: 'biset', title: 'Bi-Set: Remada e Tríceps', items: [{ name: 'Remada Baixa', details: '3x 12 a 15 reps' }, { name: 'Tríceps Pulley', details: '3x 12 a 15 reps' }], restTime: 50 },
                    { id: 'b3', type: 'biset', title: 'Bi-Set: Ombros', items: [{ name: 'Desenvolvimento Halteres', details: '3x 10 reps' }, { name: 'Elevação Lateral', details: '3x 12 reps' }], restTime: 45 },
                    { id: 'b4', type: 'biset', title: 'Bi-Set: Abdômen', items: [{ name: 'Prancha Abdominal', details: '3x 40s (Timer!)' }, { name: 'Abdominal Supra', details: '3x 20 reps' }], restTime: 45 }
                ]
            },
            C: {
                title: "Treino C: Posterior e Glúteo",
                description: "Foco na cadeia posterior.",
                exercises: [
                    { id: 'c1', type: 'biset', title: 'Bi-Set: Pré-Exaustão', items: [{ name: 'Mesa Flexora', details: '4x 12 reps' }, { name: 'Cadeira Abdutora', details: '4x 20 reps (Inclinado)' }], restTime: 45 },
                    { id: 'c2', type: 'single', title: 'Stiff', items: [{ name: 'Stiff', details: '3x 12 reps' }], restTime: 60 },
                    { id: 'c3', type: 'single', title: 'Elevação Pélvica', items: [{ name: 'Elevação Pélvica', details: '3x 10 reps (Isometria)' }], restTime: 60 },
                    { id: 'c4', type: 'single', title: 'Cadeira Flexora', items: [{ name: 'Cadeira Flexora', details: '3x 15 reps' }], restTime: 45 }
                ]
            }
        };

        const RUNNING_PROTOCOL = [
            { week: 'S1', action: '2 min Corre / 1 min Anda (15 min)' },
            { week: 'S2', action: '3 min Corre / 1 min Anda (20 min)' },
            { week: 'S3', action: '5 min Corre / 2 min Anda (25 min)' },
            { week: 'S4', action: '10 a 15 min Contínuos (Teste)' },
        ];

        // --- SISTEMA DE DADOS (LOCALSTORAGE) ---
        const DATA_KEY = 'operacao_dezembro_data_v2';

        function getTodayKey() { return new Date().toLocaleDateString('pt-BR'); }

        function getAllData() {
            return JSON.parse(localStorage.getItem(DATA_KEY) || '{}');
        }

        function getTodayData() {
            const all = getAllData();
            const today = getTodayKey();
            if (!all[today]) all[today] = {};
            return all[today];
        }

        function saveExerciseData(exerciseId, data) {
            const all = getAllData();
            const today = getTodayKey();
            if (!all[today]) all[today] = {};
            
            // Mescla os dados novos com os existentes para aquele exercício
            all[today][exerciseId] = { ...all[today][exerciseId], ...data };
            
            localStorage.setItem(DATA_KEY, JSON.stringify(all));
        }

        function getExerciseData(exerciseId) {
            const todayData = getTodayData();
            return todayData[exerciseId] || {};
        }

        // --- GLOBAL STATE ---
        let timerInterval = null;
        let timerTime = 0;
        let timerMode = 'workout'; 
        let timerActive = false;
        let currentRestTime = 0;
        let isMuted = false;

        const appDiv = document.getElementById('app');
        const modal = document.getElementById('timer-modal');
        const timerDisplay = document.getElementById('timer-display');
        const badgeMode = document.getElementById('modal-mode-badge');

        // --- RENDER HOME ---
        function renderHome() {
            const today = new Date().getDay();
            const schedule = {
                1: { key: 'A', title: 'Inferior (A)' },
                2: { key: 'B', title: 'Superior (B)' },
                3: { key: 'C', title: 'Posterior (C)' },
                4: { key: 'B', title: 'Superior (B)' },
                5: { key: 'A', title: 'Inferior (A)' },
                6: { key: 'cardio', title: 'Cardio' },
                0: { key: 'rest', title: 'Descanso' }
            };

            const suggestion = schedule[today] || schedule[0];
            const todayData = getTodayData();
            const workoutsKeys = Object.keys(WORKOUT_PLAN);
            
            // Verifica se tem algum dado salvo de corrida hoje para considerar "treino iniciado"
            const activeToday = Object.keys(todayData).length > 0;

            let html = `
                <div class="bg-slate-900 text-white p-5 sticky top-0 z-10 shadow-lg mb-4">
                    <div class="flex justify-between items-end">
                        <div>
                            <p class="text-xs text-emerald-400 font-bold uppercase tracking-widest mb-1">Operação Dezembro</p>
                            <h1 class="text-2xl font-bold">Olá, Atleta!</h1>
                        </div>
                        <div class="text-right">
                             <p class="text-xs text-slate-400">Hoje</p>
                             <p class="text-lg font-bold text-white">${suggestion.title}</p>
                        </div>
                    </div>
                </div>

                <div class="p-4 space-y-6 fade-in">
            `;

            if (suggestion.key !== 'rest' && suggestion.key !== 'cardio') {
                 html += `
                    <button onclick="renderWorkout('${suggestion.key}')" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white p-6 rounded-2xl shadow-xl shadow-emerald-900/20 text-left transition-transform active:scale-95 border border-emerald-500 relative overflow-hidden group">
                        <div class="relative z-10">
                            <span class="bg-emerald-800 text-emerald-100 text-xs px-2 py-1 rounded font-bold uppercase">Sugestão do Dia</span>
                            <h2 class="text-3xl font-bold mt-2 mb-1">Treino ${suggestion.key}</h2>
                            <p class="text-emerald-100 text-sm opacity-90">Clique para iniciar o registro.</p>
                        </div>
                        <i data-lucide="zap" class="absolute right-[-20px] bottom-[-20px] w-32 h-32 text-emerald-500 opacity-20 group-hover:scale-110 transition-transform"></i>
                    </button>
                 `;
            }

            html += `<h3 class="font-bold text-slate-700 text-lg flex items-center gap-2 mt-6"><i data-lucide="list"></i> Todos os Treinos</h3>
                     <div class="grid gap-3">`;

            workoutsKeys.forEach(key => {
                const plan = WORKOUT_PLAN[key];
                html += `
                    <button onclick="renderWorkout('${key}')" class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex justify-between items-center hover:border-emerald-500 transition-colors text-left">
                        <div>
                            <h4 class="font-bold text-slate-800">${plan.title}</h4>
                            <p class="text-xs text-slate-500">${plan.exercises.length} exercícios</p>
                        </div>
                        <div class="bg-slate-100 p-2 rounded-full text-slate-400">
                            <i data-lucide="chevron-right" width="20"></i>
                        </div>
                    </button>
                `;
            });

            html += `</div></div>`;
            appDiv.innerHTML = html;
            lucide.createIcons();
        }

        // --- RENDER WORKOUT ---
        function renderWorkout(key) {
            const plan = WORKOUT_PLAN[key];
            const storedRun = getExerciseData(`run_${key}`);

            let html = `
                <div class="bg-white border-b border-slate-200 sticky top-0 z-20 px-4 py-3 flex items-center gap-3 shadow-sm">
                    <button onclick="renderHome()" class="p-2 -ml-2 hover:bg-slate-100 rounded-full text-slate-600">
                        <i data-lucide="arrow-left"></i>
                    </button>
                    <div>
                        <h1 class="font-bold text-lg leading-tight text-slate-800">${plan.title}</h1>
                        <p class="text-xs text-slate-500">Registre cargas e repetições</p>
                    </div>
                </div>

                <div class="p-4 space-y-4 pb-32 max-w-lg mx-auto">
            `;

            // Exercises Cards
            plan.exercises.forEach(ex => {
                const stored = getExerciseData(ex.id); // { items: [{w, r}, {w, r}], done: bool }
                const isDone = stored.done;
                const safeEx = JSON.stringify(ex).replace(/"/g, '&quot;');

                // Generate Items HTML with Inputs
                let itemsHtml = '';
                ex.items.forEach((item, idx) => {
                    const savedWeight = stored.items?.[idx]?.weight || '';
                    const savedReps = stored.items?.[idx]?.reps || '';

                    itemsHtml += `
                        <div class="mb-3 last:mb-0">
                            <div class="flex justify-between items-baseline mb-1">
                                <span class="font-bold text-slate-700 text-sm">${item.name}</span>
                                <span class="text-[10px] text-slate-400 font-mono">${item.details.split('(')[0]}</span>
                            </div>
                            <div class="flex gap-2">
                                <div class="relative w-1/2">
                                    <input type="number" placeholder="kg" value="${savedWeight}" id="w-${ex.id}-${idx}" class="input-compact pl-7" inputmode="numeric">
                                    <span class="absolute left-2 top-1.5 text-xs text-slate-400 font-bold">Kg</span>
                                </div>
                                <div class="relative w-1/2">
                                    <input type="number" placeholder="Reps" value="${savedReps}" id="r-${ex.id}-${idx}" class="input-compact pl-2 text-center" inputmode="numeric">
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                    <div id="card-${ex.id}" class="bg-white rounded-xl border-2 ${isDone ? 'card-done' : 'border-slate-200'} shadow-sm transition-all duration-300">
                        <!-- Header Card -->
                        <div class="p-4 pb-2 border-b border-slate-100/50 flex justify-between items-center">
                            <span class="text-[10px] font-bold uppercase tracking-wider ${ex.type === 'biset' ? 'text-amber-600 bg-amber-50' : 'text-blue-600 bg-blue-50'} px-2 py-0.5 rounded">
                                ${ex.type === 'biset' ? 'Bi-Set' : 'Série Normal'}
                            </span>
                            <span class="text-xs text-slate-400 flex items-center gap-1">
                                <i data-lucide="clock" width="12"></i> ${ex.restTime}s
                            </span>
                        </div>
                        
                        <!-- Inputs Content -->
                        <div class="p-4">
                            ${itemsHtml}
                        </div>

                        <!-- Action Footer (Buttons Row) -->
                        <div class="p-2 border-t border-slate-100 grid grid-cols-3 gap-2">
                            <button onclick="openTimer('workout', '${ex.title}', 0)" class="action-btn btn-exec">
                                <i data-lucide="play" width="16"></i> Executar
                            </button>
                            <button onclick="openTimer('rest', 'Descanso', ${ex.restTime})" class="action-btn btn-rest">
                                <i data-lucide="timer" width="16"></i> Descanso
                            </button>
                            <button onclick="toggleDone('${ex.id}', ${ex.items.length})" id="btn-check-${ex.id}" class="action-btn btn-check ${isDone ? 'checked' : ''}">
                                <i data-lucide="${isDone ? 'check' : 'square'}" width="16"></i> ${isDone ? 'Feito' : 'Concluir'}
                            </button>
                        </div>
                    </div>
                `;
            });

            // Running Card
            const runDone = storedRun.done;
            const weekProto = RUNNING_PROTOCOL[0].action; // Exemplo fixo na semana 1 ou lógica de data poderia ser aplicada

            html += `
                <div id="card-run_${key}" class="bg-white rounded-xl border-2 ${runDone ? 'border-emerald-500 bg-emerald-50' : 'border-slate-200'} shadow-sm mt-6">
                    <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2">
                            <i data-lucide="wind" class="text-blue-500"></i> Pós-Treino: Corrida
                        </h3>
                    </div>
                    <div class="p-4 space-y-3">
                        <p class="text-xs text-slate-500 bg-slate-100 p-2 rounded">Meta: ${weekProto}</p>
                        
                        <div class="grid grid-cols-3 gap-2">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Tempo</label>
                                <input type="number" id="run-time" value="${storedRun.time || ''}" placeholder="min" class="input-compact" inputmode="numeric">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Distância</label>
                                <input type="number" id="run-dist" value="${storedRun.dist || ''}" placeholder="km" class="input-compact" inputmode="decimal">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Vel. Méd</label>
                                <input type="number" id="run-speed" value="${storedRun.speed || ''}" placeholder="km/h" class="input-compact" inputmode="decimal">
                            </div>
                        </div>
                    </div>
                    <div class="p-2 border-t border-slate-100">
                        <button onclick="saveRun('run_${key}')" class="w-full action-btn ${runDone ? 'btn-check checked' : 'btn-check'}">
                            <i data-lucide="save"></i> ${runDone ? 'Corrida Salva' : 'Salvar Dados da Corrida'}
                        </button>
                    </div>
                </div>
            `;

            html += `</div>`;
            appDiv.innerHTML = html;
            lucide.createIcons();
            window.scrollTo(0, 0);
        }

        // --- LOGIC: CARDS & DATA ---

        function toggleDone(exId, itemsCount) {
            const card = document.getElementById(`card-${exId}`);
            const btn = document.getElementById(`btn-check-${exId}`);
            
            // Coletar dados dos inputs
            const itemsData = [];
            for(let i=0; i<itemsCount; i++) {
                const w = document.getElementById(`w-${exId}-${i}`).value;
                const r = document.getElementById(`r-${exId}-${i}`).value;
                itemsData.push({ weight: w, reps: r });
            }

            // Verifica estado atual
            const currentData = getExerciseData(exId);
            const newState = !currentData.done;

            // Salva
            saveExerciseData(exId, { 
                done: newState,
                items: itemsData
            });

            // Atualiza UI
            if (newState) {
                card.classList.add('card-done');
                card.classList.remove('border-slate-200');
                btn.classList.add('checked');
                btn.innerHTML = `<i data-lucide="check" width="16"></i> Feito`;
                confetti({ particleCount: 30, spread: 50, origin: { y: 0.7 }, colors: ['#10b981', '#34d399'] });
            } else {
                card.classList.remove('card-done');
                card.classList.add('border-slate-200');
                btn.classList.remove('checked');
                btn.innerHTML = `<i data-lucide="square" width="16"></i> Concluir`;
            }
            lucide.createIcons();
        }

        function saveRun(runId) {
            const time = document.getElementById('run-time').value;
            const dist = document.getElementById('run-dist').value;
            const speed = document.getElementById('run-speed').value;

            if(!time && !dist) {
                alert("Preencha pelo menos o tempo ou distância.");
                return;
            }

            saveExerciseData(runId, {
                done: true,
                time, dist, speed
            });

            const card = document.getElementById(`card-${runId}`);
            card.classList.remove('border-slate-200');
            card.classList.add('border-emerald-500', 'bg-emerald-50');
            
            // Feedback visual no botão
            const btn = card.querySelector('button');
            btn.innerHTML = `<i data-lucide="check"></i> Salvo com Sucesso!`;
            btn.classList.add('checked');
            
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.8 } });
            lucide.createIcons();
        }

        // --- LOGIC: TIMER MODAL ---

        function openTimer(mode, title, duration) {
            // Setup Modal
            timerMode = mode;
            currentRestTime = duration;
            document.getElementById('modal-title').innerText = title;
            
            // Setup UI based on mode
            if (mode === 'workout') {
                timerTime = 0;
                badgeMode.innerText = "Execução";
                badgeMode.className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide bg-blue-500 text-white";
                document.getElementById('lbl-toggle').innerText = "Iniciar Cronômetro";
                timerDisplay.classList.remove('text-amber-400');
                timerDisplay.classList.add('text-white');
            } else {
                timerTime = duration;
                badgeMode.innerText = "Descanso";
                badgeMode.className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide bg-amber-500 text-white";
                document.getElementById('lbl-toggle').innerText = "Iniciar Contagem";
                timerDisplay.classList.add('text-amber-400');
                timerDisplay.classList.remove('text-white');
            }

            updateDisplay();
            stopTimer(); // Reset state
            modal.classList.remove('hidden');
        }

        function updateDisplay() {
            const mins = Math.floor(timerTime / 60);
            const secs = timerTime % 60;
            timerDisplay.innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function toggleTimer() {
            if (timerActive) {
                stopTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            timerActive = true;
            document.getElementById('lbl-toggle').innerText = "Pausar";
            const btn = document.getElementById('btn-toggle-timer');
            btn.classList.remove('bg-emerald-500', 'hover:bg-emerald-600');
            btn.classList.add('bg-red-500', 'hover:bg-red-600');

            timerInterval = setInterval(() => {
                if (timerMode === 'rest') {
                    if (timerTime <= 0) {
                        playBeep();
                        stopTimer();
                        return;
                    }
                    timerTime--;
                } else {
                    timerTime++;
                }
                updateDisplay();
            }, 1000);
        }

        function stopTimer() {
            timerActive = false;
            clearInterval(timerInterval);
            document.getElementById('lbl-toggle').innerText = timerMode === 'rest' ? "Continuar" : "Iniciar";
            const btn = document.getElementById('btn-toggle-timer');
            btn.classList.add('bg-emerald-500', 'hover:bg-emerald-600');
            btn.classList.remove('bg-red-500', 'hover:bg-red-600');
            
            if(timerMode === 'rest' && timerTime === currentRestTime) {
                 document.getElementById('lbl-toggle').innerText = "Iniciar Contagem";
            }
        }

        function resetTimer() {
            stopTimer();
            timerTime = timerMode === 'rest' ? currentRestTime : 0;
            updateDisplay();
        }

        function playBeep() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, ctx.currentTime);
            gain.gain.setValueAtTime(0.5, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
            osc.start();
            osc.stop(ctx.currentTime + 0.5);
        }

        // Listeners
        document.getElementById('btn-close-modal').onclick = () => { modal.classList.add('hidden'); stopTimer(); };
        document.getElementById('btn-toggle-timer').onclick = toggleTimer;
        document.getElementById('btn-reset-timer').onclick = resetTimer;

        // Init
        renderHome();

    </script>
</body>
</html>
